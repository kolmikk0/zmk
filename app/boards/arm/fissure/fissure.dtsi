/dts-v1/;
#include <nordic/nrf52840_qiaa.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>

#define CAT2_(a, b) a ## b
#define CAT2(a, b) CAT2_(a,b)
#define PIX(c, rgb) PIX_(c, rgb)
#define RGB_(c, xyz) RGB(c, xyz)
#define PIX_(c, rgb) RGB_(SW(CAT2(A, c)), FOR_EACH(CS, (,), CAT2(RGB_CS, rgb)))
#define BGR_SCALING 255 255 255
//255 200 180

#define A0 4
#define A1 3
#define A2 2
#define A3 1

/ {
    model = "fissure";
    compatible = "fissure";

    chosen {
        zephyr,code-partition = &code_partition;
        zephyr,sram = &sram0;
        zephyr,flash = &flash0;
        zmk,kscan = &kscan;
		zmk,matrix_transform = &transform;
        zmk,steno-flash = &steno_flash;
        zmk,battery = &vbat;
        zmk,led-widgets-dev = &rgb;
    };

	transform: transform {
		compatible = "zmk,matrix-transform";
		columns = <12>;
		rows = <4>;
		map = <
RC(0,0) RC(2,1) RC(0,1) RC(0,2) RC(0,3) RC(0,4)   RC(4,4) RC(4,3) RC(4,2) RC(4,1) RC(6,1) RC(5,0)
RC(1,0) RC(2,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4)   RC(5,4) RC(5,3) RC(5,2) RC(5,1) RC(6,0) RC(4,0)
        RC(3,0) RC(3,1) RC(2,2) RC(2,3) RC(2,4)   RC(6,4) RC(6,3) RC(6,2) RC(7,1) RC(7,0)
                        RC(3,2) RC(3,3) RC(3,4)   RC(7,4) RC(7,3) RC(7,2)
		>;
	};

    kscan: kscan {
        compatible = "zmk,kscan-gpio-matrix";
        diode-direction = "row2col";
        row-gpios
            = <&gpio1 11 GPIO_ACTIVE_HIGH>
            , <&gpio1 10 GPIO_ACTIVE_HIGH>
            , <&gpio0  3 GPIO_ACTIVE_HIGH>
            , <&gpio0 28 GPIO_ACTIVE_HIGH>
            ;
        col-gpios
            = <&gpio1 13 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio0  2 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio0 29 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio0 31 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&gpio0 30 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            ;
    };


    vbat: vbat {
        compatible = "zmk,battery-voltage-divider";
        io-channels = <&adc 3>;
        power-gpios = <&gpio1 9 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
        output-ohms = <100000>;
        full-ohms = <(100000 + 100000)>;
    };
};

&i2c0 {
    compatible = "nordic,nrf-twi";
    status = "okay";
    pinctrl-0 = <&i2c0_def>;
    pinctrl-1 = <&i2c0_slp>;
    pinctrl-names = "default", "sleep";
	rgb: is31fl3729@34 {
        compatible = "issi,is31fl3729";
        status = "okay";
        reg = <0x34>;
        r-ext = <10>;
        led-max-current = <1>;
        sw-setting = <5>;           // first 4 SW lines
        pwm-frequency = <5>;        // 0.5kHz
        sdb-gpios = <&gpio0 26 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
        chain-length = <60>;
        scaling = <BGR_SCALING BGR_SCALING BGR_SCALING BGR_SCALING BGR_SCALING 0>;
    };
};

&spi1 {
    compatible = "nordic,nrf-spim";
    status = "okay";
    pinctrl-0 = <&spi1_def>;
    pinctrl-1 = <&spi1_slp>;
    pinctrl-names = "default", "sleep";

    steno_flash: nor-flash@0 {
        reg = <0>;
        compatible = "jedec,spi-nor";
        status = "okay";
        spi-max-frequency = <8000000>;
        size = <0x8000000>;
        has-dpd;
        t-enter-dpd = <3000>;
        t-exit-dpd = <30000>;
    };
};

&adc {
    status = "okay";
};

&gpiote {
    status = "okay";
};

&gpio0 {
    status = "okay";
};

&gpio1 {
    status = "okay";
};

&usbd {
    status = "okay";
};


&flash0 {
    /*
     * For more information, see:
     * http://docs.zephyrproject.org/latest/devices/dts/flash_partitions.html
     */
    partitions {
        compatible = "fixed-partitions";
        #address-cells = <1>;
        #size-cells = <1>;

        code_partition: partition@0 {
            label = "code_partition";
            reg = <0x00000000 0x000e0000>;
        };

        /*
         * Storage partition will be used by FCB/LittleFS/NVS
         * if enabled.
         */
        storage_partition: partition@e0000 {
            label = "storage";
            reg = <0x000e0000 0x00020000>;
        };
    };
};
